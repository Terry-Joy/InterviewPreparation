
## 1、IP协议概念
IP（Internet Protocol , 互联网协议）主要用于互联网通信，位于网络层。IP协议用于将多个包交换网络连接起来，他在原地址和目的地址之间传输数据报，还提供对数据大小的重新组装功能，以适应不同网络的要求。

IP协议是TCP/IP协议族的核心协议，最常用的IP协议的版本号是4，即IPV4 ，它的下一个版本就是 IPV6。

## 2.IP服务的特点
IP协议是TCP/IP协议族的动力，它为上层协议提供无状态、无连接、不可靠的服务。

无状态是指IP通信双方不同步传输数据的状态信息，因此所有IP数据报的发送、传输和接收都是相互独立、没有上下文关系的。这种服务最大的缺点就是无法处理乱序和重复的IP数据报。面向连接的协议，比如TCP协议，能够自己处理乱序的、重复的报文段，它递交给上层协议的内容绝对是有序的、正确的。无状态服务的优点也很明显：简单、高效。我们无需为保持通信的状态而分配一些内核资源，也无需每次传输数据时都携带状态信息。

无连接是指IP通信双方都不长久地维持对方的任何信息。这样上层协议每次发送数据的时候，都必须明确指定对方的IP地址。

不可靠是指IP协议不能保证IP数据报准确地到达接收端，它只是承诺尽最大努力。很多情况都可以导致IP数据报发送失败。比如，某个中转路由器发现IP数据报在网络上存活地时间太长，那么它将丢弃该报文，并返回一个ICMP错误消息给发送端。因此，使用IP服务地上层协议需要自己实现数据确认、超时重传等机制以达到可靠传输的目的。


## 2、IP协议报文格式 （20bytes)

[![bpLh2F.png](https://s4.ax1x.com/2022/02/23/bpLh2F.png)](https://imgtu.com/i/bpLh2F)
(1)版本　占4位，指IP协议的版本。通信双方使用的IP协议版本必须一致。目前广泛使用的IP协议版本号为4（即IPv4）。关于IPv6，目前还处于草案阶段。

(2)首部长度　占4位，可表示的最大十进制数值是15。请注意，这个字段所表示数的单位是32位字长（1个32位字长是4字节），因此，当IP的首部长度为1111时（即十进制的15），首部长度就达到60字节。当IP分组的首部长度不是4字节的整数倍时，必须利用最后的填充字段加以填充。因此数据部分永远在4字节的整数倍开始，这样在实现IP协议时较为方便。首部长度限制为60字节的缺点是有时可能不够用。但这样做是希望用户尽量减少开销。最常用的首部长度就是20字节（即首部长度为0101），这时不使用任何选项。

(3)区分服务　占8位，用来获得更好的服务。这个字段在旧标准中叫做服务类型，但实际上一直没有被使用过。1998年IETF把这个字段改名为区分服务DS(Differentiated Services)。只有在使用区分服务时，这个字段才起作用。

(4)总长度　总长度指首部和数据之和的长度，单位为字节。总长度字段为16位，因此数据报的最大长度为216-1=65535字节。
在IP层下面的每一种数据链路层都有自己的帧格式，其中包括帧格式中的数据字段的最大长度，这称为最大传送单元MTU(Maximum Transfer Unit)。当一个数据报封装成链路层的帧时，此数据报的总长度（即首部加上数据部分）一定不能超过下面的数据链路层的MTU值。

(5)标识(identification)　占16位。IP软件在存储器中维持一个计数器，每产生一个数据报，计数器就加1，并将此值赋给标识字段。但这个“标识”并不是序号，因为IP是无连接服务，数据报不存在按序接收的问题。当数据报由于长度超过网络的MTU而必须分片时，这个标识字段的值就被复制到所有的数据报的标识字段中。相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报。

(6)标志(flag)　占3位，但目前只有2位有意义。
●　标志字段中的最低位记为MF(More Fragment)。MF=1即表示后面“还有分片”的数据报。MF=0表示这已是若干数据报片中的最后一个
●　标志字段中间的一位记为DF(Don’t Fragment)，意思是“不能分片”。只有当DF=0时才允许分片。

(7)片偏移　占13位。片偏移指出：较长的分组在分片后，某片在原分组中的相对位置。也就是说，相对用户数据字段的起点，该片从何处开始。片偏移以8个字节为偏移单位。这就是说，每个分片的长度一定是8字节（64位）的整数倍。

(8)生存时间　占8位，生存时间字段常用的的英文缩写是TTL(Time To Live)，表明是数据报在网络中的寿命。由发出数据报的源点设置这个字段。其目的是防止无法交付的数据报无限制地在因特网中兜圈子，因而白白消耗网络资源。最初的设计是以秒作为TTL的单位。每经过一个路由器时，就把TTL减去数据报在路由器消耗掉的一段时间。若数据报在路由器消耗的时间小于1秒，就把TTL值减1。当TTL值为0时，就丢弃这个数据报。

(9)协议　占8位，协议字段指出此数据报携带的数据是使用何种协议，以便使目的主机的IP层知道应将数据部分上交给哪个处理过程。

(10)首部检验和　占16位。当收到一份IP数据包后，同样对首部的每个16位进行反码求和。由于接收方在计算过程中包含了发送发在首部中的校验和，如果传输过程中没有差错，计算结果应全为1，不是全1，即检验和错误，那么就丢弃收到的数据报，但不生成差错报文，由上层发现丢失的数据报并进行重传。这个字段只检验数据报的首部，但不包括数据部分。这是因为数据报每经过一个路由器，路由器都要重新计算一下首部检验和（一些字段，如生存时间、标志、片偏移等都可能发生变化）。不检验数据部分可减少计算的工作量。

## IP地址
[![bpOeMQ.png](https://s4.ax1x.com/2022/02/23/bpOeMQ.png)](https://imgtu.com/i/bpOeMQ)

IP地址由网络号和主机号组成。网络号标识一个物理的网络，同一个网络上所有的主机需要同一个网络号，该号在整个互联网是唯一的；主机号是网络中的一个工作端、服务器、路由器其他TCP/IP主机。对于一个网络号来说主机号是唯一的。每个TCP/IP主机由一个逻辑IP地址确定。

地址经由 分类地址，子网划分，无分类地址

1>. A类地址（ 0.0.0.0 - 127.255.255.255 ）以”0”头，网络段长度为8位，其中可变部分的长度为7位；主机段长度为24位。7位的可变网络段可识别2^7=128 (0~127)个网络，其中0和127另有用途，故只有126个可用的A类网络地址。另外，主机位全”0”代表网络本身，全”1”代表网内广播，因此一个A类网络地址可识别的可分配地址有 2^24-2 个。

2>. B类地址（ 128.0.0.0 - 191.255.255.255 ）以”10”开头，网络段长度为16位，可变部分的长度为14位；主机段长度为16位。14位的可变网络段可以识别的网络数为 2^14 个。另外，主机位全”0”与全”1”功能同A类地址，因此一个B类网络可以分配地址有 2^16-2 个。

3>. C类地址（ 192.0.0.0 - 223.255.255.255 ）以”110”开头，网络段长度为24位，其中可变部分的长度为21位；主机段长度为8位。21位的可变网络段可以识别的网络数为 2^21 个。可分配的主机地址是 2^8-2 个。

4>. D类地址（ 224.0.0.0 - 239.255.255.255 ）为组播地址，使用”1110”开头，不分网络段和主机段，有 2^28 个组播地址。用于标识预先定义的一组主机。主机使用组播通信时，可以将组播数据报一次性发送给所有同组的主机。

5>. E类地址（ 240.0.0.0 - 255.255.255.255 ）是保留地址，用于研究使用。以”1111”开头，不区分网络段和主机段，其中32位全1代表本网络内广播，因此E类地址共有 2^28-1 个。

**私有IP地址和特殊IP地址**

根据用途和安全性级别的不同，IP地址还可以大致分为两类：公共地址和私有地址。公用地址在Internet中使用，可以在Internet中随意访问。

一个机构网络要连入Internet，必须申请公用IP地址。但是考虑到网络安全和内部实验等特殊情况，在IP地址中专门保留了三个区域作为私有地址，其地址范围如下：

A类：10.0.0.0/8（子网掩码表示） 10.0.0.0-10.255.255.255
B类：172.16.0.0/12 172.16.0.0-172.31.255.255
C类：192.168.0.0/16 192.168.0.0-192.168.255.255

使用保留地址的网络只能在内部进行通信，而不能与其他网络互连。因为本网络中的保留地址同样也可能被其它网络使用，如果进行网络互连，那么寻找路由时就会因为地址的不唯一而出现问题。但是这些使用保留地址的网络可以通过将本网络内的保留地址翻译转换（NAT)成公共地址的方式实现与外部网络的互连。这也是保证网络安全的重要方法之一。

## 子网划分
1.控制网络流量，限定广播的传播，提高网络性能，提高IP地址的利用率（例子在下），可以更为灵活的形成大覆盖范围的网络，保证网络安全（网段间不能直接通信，路由器或网关	，网络越小入侵途径小，同时方便部署安全策略）。
2.子网掩码的作用
（1）识别主机所在的网络地址，（子网掩码与上IP地址即可得到），判断两台主机是否同一网段上。
（1）通过设置子网掩码，将网络进一步分为多个网段。

例如，某公司有四个独立的部门，每个部门有20台左右的计算机，如果为每部分网络申请一个C类网络地址，显然非常浪费（因为C类网络可支持254个主机地址），而且还会增加路由器的负担 ，这时就可以借助子网掩码，将网络进一步划分成若干个子网，由于其IP地址的网络部分相同，所以外部的路由器就将这些子网看成同一个网络，而单位内部的路由器能区分不同的子网。

**局域网**
局域网自然就是局部地区形成的一个区域网络，私有网络，其特点就是分布地区范围有限，可大可小，建筑楼，办公室，对于外网来说，内部使用的是私有IP地址

**广域网**
是连接不同地区局域网或城域网计算机通信的远程网。通常跨接很大的物理范围，所覆盖的范围从几十公里到几千公里，它能连接多个地区、城市和国家，或横跨几个洲并能提供远距离通信，形成国际性的远程网络。（公网）

通过路由器NAT协议转换成公有IP地址。

**ICMP**（在ip地址中携带）
ICMP就是一个“错误侦测与回报机制”，其目的就是让我们能够检测网路的连线状况﹐（是否超时、终点不可达）也能确保连线的准确性，是ping和traceroute的工作协议

**IP地址与MAC地址在互联网中的作用**
1.既然有了MAC，为什么还需要IP，或者有了IP，为什么还要MAC
（1）存在一个附加层寻址的时候，移动和维修更加方便，假如IP主机从一个网络移动到另一个网络，可以重新给一个IP地址而不用更换主机，以太网卡坏了，可以更换网卡而不用取得一个新的IP地址。
（2） MAC 的作用则是实现「直连」的两个设备之间通信，而 IP 则负责在「没有直连」的两个网络之间进行通信传输。                                                   已知两个主机AB之间通信，中间有多个中间节点，节点之间通过ARP得到下一步的MAC地址，传输下去，源IP地址和目标IP地址在传输过程中是不会变化的，只有源 MAC 地址和目标 MAC 一直在变化。

**IP地址与MAC地址区别**
1、MAC地址是物理地址，IP地址是逻辑地址。现实生活中，IP地址相当于人的居住地，而人的身份证相当于MAC地址，就是说MAC地址是不可改变的，IP地址是可以更改的；（防止IP盗用）

2、MAC地址具有唯一性，每个硬件出厂时候的MAC地址是固定的；IP地址不具备唯一性，因此，很多应用软件是围绕MAC地址开发的。

3、工作层次不同

数据链路基于MAC地址转发数据帧，网络层基于IP地址转发报文。数据链路层交换机基于MAC地址表转发数据，路由器基于路由表（IP地址）转发数据。

4、长度定义

MAC地址是Ethernet网卡上带的地址，长度为48位；IP地址目前主流是32位长。IP地址和MAC地址通过ARP协议联系到一起。